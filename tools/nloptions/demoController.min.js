angular.module("myapp",[]).factory("dataValue",["$http","$q",function(e,t){function r(){var n=t.defer();return e.get(a).success(function(e){var t=e.length-2,a=e.substring(6,t);n.resolve(JSON.parse(a).query.results.quote.LastTradePriceOnly)}),n.promise}function i(){var a=t.defer();return e.get(n).success(function(e){var t=e.length-2,n=e.substring(6,t);a.resolve(JSON.parse(n).query.results.rate)}),a.promise}var a="https://query.yahooapis.com/v1/public/yql?q=select%20LastTradePriceOnly%20from%20yahoo.finance.quote%20where%20symbol%20in%20(%22NLN.TO%22)&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&format=json&callback=a",n="https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.xchange%20where%20pair%20in%20(%22CADUSD%22,%20%22USDCNY%22)&env=store://datatables.org/alltableswithkeys&format=json&callback=a";return{getCurrentPrice:r,getExchange:i}}]).filter("curr",function(){return function(e){return Number(e).toFixed(2)}}).controller("myCtrl",["$scope","$timeout","dataValue",function(e,t,a){function i(){var t=0,a=0;e.$watch("dataList1",function(n){angular.forEach(n,function(e){a=l(s(o(e.begin),e.total),a),t=l(t,e.total)}),e.TotalValue=t,e.Current=a,e.TotalValueCny=s(e.TotalValue,e.ExchangeRateCny),e.CurrentCny=s(e.Current,e.ExchangeRateCny)})}function o(e){var a,t=new Date(e).getTime(),n=(new Date).getTime()-t,r=31536e6,i=63072e6,o=94608e6,c=126144e6;return r>n?a=0:i>n?a=.25:o>n?a=.5:c>n?a=.75:n>c&&(a=1),a}function c(e){var t=e.substring(0,1)>0?e:e.substring(1,2);return t}function l(e,t){var a,n,r;try{n=e.toString().split(".")[1].length}catch(i){n=0}try{r=t.toString().split(".")[1].length}catch(i){r=0}return a=Math.pow(10,Math.max(n,r)),(e*a+t*a)/a}function u(e,t){var a,n,r,i;try{n=e.toString().split(".")[1].length}catch(o){n=0}try{r=t.toString().split(".")[1].length}catch(o){r=0}return a=Math.pow(10,Math.max(n,r)),i=n>=r?n:r,((e*a-t*a)/a).toFixed(i)}function s(e,t){var a=0;try{a+=e.toString().split(".")[1].length}catch(n){}try{a+=t.toString().split(".")[1].length}catch(n){}return Number(e.toString().replace(".",""))*Number(t.toString().replace(".",""))/Math.pow(10,a)}e.dataList1=window.localStorage.getItem("dataList")?JSON.parse(window.localStorage.getItem("dataList")):[],e.CurrentPrice=window.localStorage.getItem("CurrentPrice")?window.localStorage.getItem("CurrentPrice"):0,e.ExchangeRate=window.localStorage.getItem("ExchangeRate")?JSON.parse(window.localStorage.getItem("ExchangeRate"))[0].Rate:0,e.ExchangeRateCny=window.localStorage.getItem("ExchangeRate")?JSON.parse(window.localStorage.getItem("ExchangeRate"))[1].Rate:0,e.showctrl=!0,e.showctrl2=!1,e.TotalValue=0,e.Current=0,e.TotalValueCny=0,e.CurrentCny=0,e.dataList=e.dataList1,a.getCurrentPrice().then(function(e){window.localStorage.setItem("CurrentPrice",e)}),a.getExchange().then(function(e){window.localStorage.setItem("ExchangeRate",JSON.stringify(e))});var n=null,r=0;n=setInterval(function(){r++,r>100&&clearInterval(n),e.$apply(function(){e.CurrentPrice=window.localStorage.getItem("CurrentPrice"),window.localStorage.getItem("ExchangeRate")&&(e.ExchangeRate=JSON.parse(window.localStorage.getItem("ExchangeRate"))[0].Rate,e.ExchangeRateCny=JSON.parse(window.localStorage.getItem("ExchangeRate"))[1].Rate,e.ConvertedPrice=s(e.CurrentPrice,e.ExchangeRate),e.ConvertedPriceCny=s(e.ConvertedPrice,e.ExchangeRateCny))})},100),$("#datepicker").datepicker().on("changeDate",function(){e.begin=$("#datepicker").val()}),$("#expiration").datepicker().on("changeDate",function(){e.expiration=$("#expiration").val()}),e.add=function(a,n,r){var o={},l=[a,n,r.quantity,r.quantity,r.exercise].some(function(e){return null==e});return l?void alert("请填写正确信息"):(o.begin=new Date(a.substring(6,11),c(a.substring(0,2))-1,c(a.substring(3,5))),o.expiration=new Date(n.substring(6,11),c(n.substring(0,2))-1,c(n.substring(3,5))),o.quantity=r.quantity,o.exercise=r.exercise,o.stage1=new Date(o.begin.getTime()+31536e6),o.stage2=new Date(o.begin.getTime()+63072e6),o.stage3=new Date(o.begin.getTime()+94608e6),o.stage4=new Date(o.begin.getTime()+126144e6),o.total=s(u(e.ConvertedPrice,r.exercise),r.quantity),e.dataList1.push(o),window.localStorage.setItem("dataList",angular.toJson(e.dataList1)),void t(i,100))},e.del=function(a){e.dataList1.splice(a,1),window.localStorage.setItem("dataList",angular.toJson(e.dataList1)),t(i,100)},e.$watch("CurrentPrice",function(t){window.localStorage.setItem("CurrentPrice",t),e.ConvertedPrice=s(e.CurrentPrice,e.ExchangeRate),e.ConvertedPriceCny=s(e.ConvertedPrice,e.ExchangeRateCny),e.TotalValue=0,e.Current=0,angular.forEach(e.dataList1,function(t){t.total=s(u(e.ConvertedPrice,t.exercise),t.quantity),e.TotalValue=l(e.TotalValue,t.total),e.Current=l(s(o(t.begin),t.total),e.Current),e.TotalValueCny=s(e.TotalValue,e.ExchangeRateCny),e.CurrentCny=s(e.Current,e.ExchangeRateCny)})}),e.show=function(){e.showctrl=!0,e.showctrl2=!1},e.hide=function(){e.showctrl=!1,e.showctrl2=!0}}]);