angular.module("myapp",[]).factory("dataValue",["$http","$q",function(e,t){function r(){var n=t.defer();return e.get(a).success(function(e){var t=e.length-2,a=e.substring(6,t);n.resolve(JSON.parse(a).query.results.quote.LastTradePriceOnly)}),n.promise}function i(){var a=t.defer();return e.get(n).success(function(e){var t=e.length-2,n=e.substring(6,t);a.resolve(JSON.parse(n).query.results.rate)}),a.promise}var a="https://query.yahooapis.com/v1/public/yql?q=select%20LastTradePriceOnly%20from%20yahoo.finance.quote%20where%20symbol%20in%20(%22NLN.TO%22)&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys&format=json&callback=a",n="https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20yahoo.finance.xchange%20where%20pair%20in%20(%22CADUSD%22,%20%22USDCNY%22)&env=store://datatables.org/alltableswithkeys&format=json&callback=a";return{getCurrentPrice:r,getExchange:i}}]).filter("curr",function(){return function(e){return Number(e).toFixed(2)}}).controller("myCtrl",["$scope","$timeout","dataValue",function(e,t,a){function i(){var e=new Date,t=new Date(Number(window.localStorage.getItem("slidertime"))),a=12*(t.getFullYear()-e.getFullYear())+(t.getMonth()-e.getMonth())+(t.getDate()-e.getDate()<0?0:1);return a}function o(){var t=0,a=0;e.slidertime=0,e.$watch("dataList1",function(n){angular.forEach(n,function(n){a=u(w(c(n.begin),n.total),a),t=u(t,n.total),e.slidertime=e.slidertime<=new Date(n.stage4).getTime()?new Date(n.stage4).getTime():e.slidertime}),0==n.length&&(e.slidertime=0),window.localStorage.setItem("slidertime",e.slidertime),e.TotalValue=t,e.Current=a,e.TotalValueCny=w(e.TotalValue,e.ExchangeRateCny).toFixed(2),e.CurrentCny=w(e.Current,e.ExchangeRateCny).toFixed(2),$("#slider").slider("option","max",i()),$("#slider").slider("option","value",0)})}function c(e){var a,t=new Date(e).getTime(),n=(new Date).getTime()-t,r=31536e6,i=63072e6,o=94608e6,l=126144e6;return r>n?a=0:i>n?a=.25:o>n?a=.5:l>n?a=.75:n>l&&(a=1),a}function g(e,t){var n,a=new Date(e).getTime(),r=a-new Date(t).getTime(),i=31536e6,o=63072e6,l=94608e6,c=126144e6;return n=i>r?0:o>r?.25:l>r?.5:c>r?.75:r>c?1:1}function u(e,t){var a,n,r;try{n=e.toString().split(".")[1].length}catch(i){n=0}try{r=t.toString().split(".")[1].length}catch(i){r=0}return a=Math.pow(10,Math.max(n,r)),(e*a+t*a)/a}function d(e,t){var a,n,r,i;try{n=e.toString().split(".")[1].length}catch(o){n=0}try{r=t.toString().split(".")[1].length}catch(o){r=0}return a=Math.pow(10,Math.max(n,r)),i=n>=r?n:r,((e*a-t*a)/a).toFixed(i)}function w(e,t){var a=0;try{a+=e.toString().split(".")[1].length}catch(n){}try{a+=t.toString().split(".")[1].length}catch(n){}return Number(e.toString().replace(".",""))*Number(t.toString().replace(".",""))/Math.pow(10,a)}e.dataList1=window.localStorage.getItem("dataList")?JSON.parse(window.localStorage.getItem("dataList")):[],e.CurrentPrice=window.localStorage.getItem("CurrentPrice")?window.localStorage.getItem("CurrentPrice"):0,e.ExchangeRate=window.localStorage.getItem("ExchangeRate")?JSON.parse(window.localStorage.getItem("ExchangeRate"))[0].Rate:0,e.ExchangeRateCny=window.localStorage.getItem("ExchangeRate")?JSON.parse(window.localStorage.getItem("ExchangeRate"))[1].Rate:0,e.slidertime=window.localStorage.getItem("slidertime")?JSON.parse(window.localStorage.getItem("slidertime")):0,e.showctrl=!0,e.showctrl2=!1,e.todayTime=new Date,e.TotalValue=0,e.Current=0,e.TotalValueCny=0,e.CurrentCny=0,e.dataList=e.dataList1,e.slider=0,e.silderBtn=window.localStorage.getItem("dataList")?0==JSON.parse(window.localStorage.getItem("dataList")).length?!1:!0:!1,a.getCurrentPrice().then(function(e){window.localStorage.setItem("CurrentPrice",e)}),a.getExchange().then(function(e){window.localStorage.setItem("ExchangeRate",JSON.stringify(e))}),e.endTime=function(t){e.data.expiration=new Date(t.getFullYear()+10,t.getMonth(),t.getDate())};var n=null,r=0;n=setInterval(function(){r++,r>100&&clearInterval(n),e.$apply(function(){e.CurrentPrice=window.localStorage.getItem("CurrentPrice"),window.localStorage.getItem("ExchangeRate")&&(e.ExchangeRate=JSON.parse(window.localStorage.getItem("ExchangeRate"))[0].Rate,e.ExchangeRateCny=JSON.parse(window.localStorage.getItem("ExchangeRate"))[1].Rate,e.ConvertedPrice=w(e.CurrentPrice,e.ExchangeRate).toFixed(2),e.ConvertedPriceCny=w(e.CurrentPrice,w(e.ExchangeRate,e.ExchangeRateCny)).toFixed(2))})},100),e.add=function(a){var n={};n.begin=a.begin,n.expiration=a.begin,n.quantity=a.quantity,n.exercise=a.exercise,n.stage1=new Date(n.begin.getTime()+31536e6),n.stage2=new Date(n.begin.getTime()+63072e6),n.stage3=new Date(n.begin.getTime()+94608e6),n.stage4=new Date(n.begin.getTime()+126144e6),n.total=w(d(e.ConvertedPrice,a.exercise),a.quantity).toFixed(2),e.dataList1.unshift(n),window.localStorage.setItem("dataList",angular.toJson(e.dataList1)),t(o,100),e.silderBtn=!0},$("#slider").slider({min:0,value:0,max:i(),slide:function(t,a){var n=new Date,r=new Date(n.getFullYear()+parseInt((n.getMonth()+a.value)/12),(n.getMonth()+a.value)%12,n.getDate()).getTime();e.slider=a.value,e.$apply(function(){var t=0;if(angular.forEach(e.dataList,function(e){t=u(w(g(r,e.begin),e.total),t)}),e.Current=t,e.CurrentCny=w(e.Current,e.ExchangeRateCny).toFixed(2),a.value==i()){var n=new Date(Number(window.localStorage.getItem("slidertime")));e.todayTime=n}else e.todayTime=r})}}),e.del=function(a){e.dataList1.splice(a,1),0==e.dataList1.length&&(e.silderBtn=!1),window.localStorage.setItem("dataList",angular.toJson(e.dataList1)),t(o,100)},e.$watch("CurrentPrice",function(t){window.localStorage.setItem("CurrentPrice",t),e.ConvertedPrice=w(e.CurrentPrice,e.ExchangeRate).toFixed(2),e.TotalValue=0,e.Current=0,angular.forEach(e.dataList1,function(t){t.total=w(d(e.ConvertedPrice,t.exercise),t.quantity),e.TotalValue=u(e.TotalValue,t.total),e.Current=u(w(c(t.begin),t.total),e.Current),e.TotalValueCny=w(e.TotalValue,e.ExchangeRateCny),e.CurrentCny=w(e.Current,e.ExchangeRateCny)})}),e.show=function(){e.showctrl=!0,e.showctrl2=!1},e.hide=function(){e.showctrl=!1,e.showctrl2=!0}}]);